package rules

import group2.cmke.recommendationEngine.drools.Fact
import group2.cmke.recommendationEngine.drools.Fact.Mode

// ---------------------------
// 1) DISQUALIFICATION RULES
// ---------------------------

rule "DQ: Enforce allowed preferred transport modes"
salience 190
when
  $f : Fact( preferences.preferred_transport_modes != null )
then
  java.util.List prefs = $f.getPreferences().getPreferred_transport_modes();
  if (prefs == null || prefs.isEmpty()) {
    // If user didn't select any preferred modes, do NOT filter anything.
    return;
  }

  java.util.Set allowed = new java.util.HashSet();
  for (Object o : prefs) {
    if (o == null) continue;
    String p = o.toString().trim().toUpperCase().replace('-', '_').replace(' ', '_');
    allowed.add(p);
  }

  // Disqualify modes NOT in allowed set, but do NOT spam reasons per mode.
  for (Mode m : Mode.values()) {
    if (!allowed.contains(m.name())) {
      // empty reason => no spam in UI
      $f.disqualify(m, "", drools.getRule().getName());
    }
  }

  // Add ONE clear human reason (only once)
  $f.getReasons().add("You limited the recommendation to these transport types: " + allowed + ".");
  $f.getRulesTriggered().add(drools.getRule().getName());
end


rule "DQ: Walk too far"
salience 150
when
  $f : Fact( context.distance_to_destination_meters > 2000 )
then
  $f.disqualify(Mode.WALK, "Walking is not suitable because the distance is too long.", drools.getRule().getName());
end

rule "DQ: Bike too far"
salience 150
when
  $f : Fact( context.distance_to_destination_meters > 8000 )
then
  $f.disqualify(Mode.BIKE, "Biking is not suitable because the distance is too long.", drools.getRule().getName());
  $f.disqualify(Mode.E_BIKE, "E-biking is not suitable because the distance is too long.", drools.getRule().getName());
  $f.disqualify(Mode.BIKESHARE, "Bike sharing is not suitable because the distance is too long.", drools.getRule().getName());

  // Scooters usually become unrealistic at very long distances too
  $f.disqualify(Mode.SCOOTER, "Scooter is not suitable because the distance is too long.", drools.getRule().getName());
  $f.disqualify(Mode.E_SCOOTER, "E-scooter is not suitable because the distance is too long.", drools.getRule().getName());
end

rule "DQ: Bad weather disables active micromobility"
salience 160
when
  $f : Fact( preferences.weather_ok == false )
then
  $f.disqualify(Mode.BIKE, "Biking is discouraged due to bad weather.", drools.getRule().getName());
  $f.disqualify(Mode.E_BIKE, "E-biking is discouraged due to bad weather.", drools.getRule().getName());
  $f.disqualify(Mode.BIKESHARE, "Bike sharing is discouraged due to bad weather.", drools.getRule().getName());
  $f.disqualify(Mode.SCOOTER, "Scooter is discouraged due to bad weather.", drools.getRule().getName());
  $f.disqualify(Mode.E_SCOOTER, "E-scooter is discouraged due to bad weather.", drools.getRule().getName());
end

rule "DQ: Public transport not possible (no ticket and not open to buy)"
salience 170
when
  $f : Fact( preferences.has_public_transport_ticket == false,
             preferences.is_open_to_buy_ticket == false )
then
  $f.disqualify(Mode.PUBLIC_TRANSPORT, "Public transport is not available because you have no ticket and do not want to buy one.", drools.getRule().getName());
end

rule "DQ: Bike sharing not available (no bikes)"
salience 170
when
  $f : Fact( preferences.wants_bike_sharing == true,
             context.bikesAvailableAtStation == false )
then
  $f.disqualify(Mode.BIKESHARE, "Bike sharing is not available because there are no bikes at the nearest station.", drools.getRule().getName());
end


// ---- Noise-controlled ownership rule for BikeShare ----
rule "DQ: Bike sharing not needed if user owns bike"
salience 165
when
  $f : Fact( preferences.owns_non_electric_transport == true )
then
  // Only show the human reason if BIKESHARE is still an allowed candidate.
  if (!$f.isDisqualified(Mode.BIKESHARE)) {
    $f.disqualify(Mode.BIKESHARE, "Bike sharing is not needed because you already own a bike.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.BIKESHARE, "", drools.getRule().getName());
  }
end


// ---- Noise-controlled ownership rules ----
rule "DQ: Normal bike not available (user does not own non-electric transport)"
salience 140
when
  $f : Fact( preferences.owns_non_electric_transport == false )
then
  if (!$f.isDisqualified(Mode.BIKE)) {
    $f.disqualify(Mode.BIKE, "A normal bike is not considered because you do not own one.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.BIKE, "", drools.getRule().getName());
  }
end

rule "DQ: E-bike not available (user does not own e-bike)"
salience 140
when
  $f : Fact( preferences.owns_e_bike == false )
then
  if (!$f.isDisqualified(Mode.E_BIKE)) {
    $f.disqualify(Mode.E_BIKE, "An e-bike is not considered because you do not own one.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.E_BIKE, "", drools.getRule().getName());
  }
end

rule "DQ: Scooter not available (user does not own scooter)"
salience 140
when
  $f : Fact( preferences.owns_scooter == false )
then
  if (!$f.isDisqualified(Mode.SCOOTER)) {
    $f.disqualify(Mode.SCOOTER, "Scooter is not considered because you do not own one.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.SCOOTER, "", drools.getRule().getName());
  }
end

rule "DQ: E-scooter not available (user does not own e-scooter)"
salience 140
when
  $f : Fact( preferences.owns_e_scooter == false )
then
  if (!$f.isDisqualified(Mode.E_SCOOTER)) {
    $f.disqualify(Mode.E_SCOOTER, "E-scooter is not considered because you do not own one.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.E_SCOOTER, "", drools.getRule().getName());
  }
end

rule "DQ: Gas car not available (user does not own gas car)"
salience 140
when
  $f : Fact( preferences.owns_gas_car == false )
then
  if (!$f.isDisqualified(Mode.GAS_CAR)) {
    $f.disqualify(Mode.GAS_CAR, "A gas car is not considered because you do not own one.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.GAS_CAR, "", drools.getRule().getName());
  }
end

rule "DQ: Electric car not available (user does not own electric car)"
salience 140
when
  $f : Fact( preferences.owns_electric_car == false )
then
  if (!$f.isDisqualified(Mode.ELECTRIC_CAR)) {
    $f.disqualify(Mode.ELECTRIC_CAR, "An electric car is not considered because you do not own one.", drools.getRule().getName());
  } else {
    $f.disqualify(Mode.ELECTRIC_CAR, "", drools.getRule().getName());
  }
end


// ---------------------------
// 2) SCORING RULES (WEIGHTED)
// ---------------------------

rule "SCORE: Public transport not preferred"
salience 50
when
  $f : Fact( preferences.wants_public_transport == false )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, -10, "You did not express a preference for public transport.", drools.getRule().getName());
end

rule "SCORE: Bike sharing not preferred"
salience 50
when
  $f : Fact( preferences.wants_bike_sharing == false )
then
  $f.addScore(Mode.BIKESHARE, -10, "You did not express a preference for bike sharing.", drools.getRule().getName());
end

rule "SCORE: Open to buy ticket helps PT"
salience 45
when
  $f : Fact( preferences.is_open_to_buy_ticket == true )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 5, "You are open to buying a ticket, so public transport is easier.", drools.getRule().getName());
end

// High-impact: sustainability
rule "SCORE: Sustainability strongly favors eco modes"
salience 90
when
  $f : Fact( preferences.environmentally_sustainable == true )
then
  $f.addScore(Mode.WALK, 40, "You prioritize sustainability, so walking is favored.", drools.getRule().getName());
  $f.addScore(Mode.BIKE, 40, "You prioritize sustainability, so biking is favored.", drools.getRule().getName());
  $f.addScore(Mode.E_BIKE, 38, "You prioritize sustainability, so e-biking is favored.", drools.getRule().getName());
  $f.addScore(Mode.SCOOTER, 35, "You prioritize sustainability, so scooter is favored.", drools.getRule().getName());
  $f.addScore(Mode.E_SCOOTER, 35, "You prioritize sustainability, so e-scooter is favored.", drools.getRule().getName());
  $f.addScore(Mode.BIKESHARE, 35, "You prioritize sustainability, so bike sharing is favored.", drools.getRule().getName());
  $f.addScore(Mode.PUBLIC_TRANSPORT, 25, "You prioritize sustainability, so public transport is favored.", drools.getRule().getName());
  $f.addScore(Mode.ELECTRIC_CAR, -10, "You prioritize sustainability, but electric cars are more sustainable than gas cars.", drools.getRule().getName());
  $f.addScore(Mode.GAS_CAR, -30, "You prioritize sustainability, so driving a gas car is strongly discouraged.", drools.getRule().getName());
end

rule "SCORE: Has public transport ticket boosts PT"
salience 80
when
  $f : Fact( preferences.has_public_transport_ticket == true )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 15, "You have a public transport ticket, which makes public transport easier.", drools.getRule().getName());
end

rule "SCORE: Owns non-electric transport boosts bike"
salience 70
when
  $f : Fact( preferences.owns_non_electric_transport == true )
then
  $f.addScore(Mode.BIKE, 20, "You own a bike, so using your own bike is practical.", drools.getRule().getName());
end

rule "SCORE: Owns e-bike boosts e-bike"
salience 70
when
  $f : Fact( preferences.owns_e_bike == true )
then
  $f.addScore(Mode.E_BIKE, 20, "You own an e-bike, so using your e-bike is practical.", drools.getRule().getName());
end

rule "SCORE: Owns scooter boosts scooter"
salience 70
when
  $f : Fact( preferences.owns_scooter == true )
then
  $f.addScore(Mode.SCOOTER, 20, "You own a scooter, so using your scooter is practical.", drools.getRule().getName());
end

rule "SCORE: Owns e-scooter boosts e-scooter"
salience 70
when
  $f : Fact( preferences.owns_e_scooter == true )
then
  $f.addScore(Mode.E_SCOOTER, 20, "You own an e-scooter, so using your e-scooter is practical.", drools.getRule().getName());
end


// Distance band scoring (non-overlapping ranges)
rule "SCORE: Distance < 1000m favors walk"
salience 60
when
  $f : Fact( context.distance_to_destination_meters < 1000 )
then
  $f.addScore(Mode.WALK, 35, "The destination is nearby, so walking is efficient.", drools.getRule().getName());
  $f.addScore(Mode.BIKE, 15, "The destination is nearby, biking is convenient.", drools.getRule().getName());
  $f.addScore(Mode.E_BIKE, 15, "The destination is nearby, e-biking is convenient.", drools.getRule().getName());
  $f.addScore(Mode.SCOOTER, 15, "The destination is nearby, scooter is convenient.", drools.getRule().getName());
  $f.addScore(Mode.E_SCOOTER, 15, "The destination is nearby, e-scooter is convenient.", drools.getRule().getName());
end

rule "SCORE: Distance 1000-3000m favors bike/scooter"
salience 60
when
  $f : Fact( context.distance_to_destination_meters >= 1000,
             context.distance_to_destination_meters < 3000 )
then
  $f.addScore(Mode.BIKE, 25, "The distance is suitable for biking.", drools.getRule().getName());
  $f.addScore(Mode.E_BIKE, 25, "The distance is suitable for e-biking.", drools.getRule().getName());
  $f.addScore(Mode.SCOOTER, 22, "The distance is suitable for scooter.", drools.getRule().getName());
  $f.addScore(Mode.E_SCOOTER, 22, "The distance is suitable for e-scooter.", drools.getRule().getName());
  $f.addScore(Mode.BIKESHARE, 20, "The distance is suitable for bike sharing.", drools.getRule().getName());
end

rule "SCORE: Distance 3000-5000m favors PT and bikeshare"
salience 60
when
  $f : Fact( context.distance_to_destination_meters >= 3000,
             context.distance_to_destination_meters <= 5000 )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 15, "The distance is suitable for public transport.", drools.getRule().getName());
  $f.addScore(Mode.BIKESHARE, 15, "The distance works well with bike sharing.", drools.getRule().getName());
end

rule "SCORE: Distance 5000-8000m favors PT/car"
salience 60
when
  $f : Fact( context.distance_to_destination_meters > 5000,
             context.distance_to_destination_meters <= 8000 )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 25, "The distance is long, so public transport is efficient.", drools.getRule().getName());
  $f.addScore(Mode.GAS_CAR, 20, "The distance is long, so a gas car may be practical.", drools.getRule().getName());
  $f.addScore(Mode.ELECTRIC_CAR, 22, "The distance is long, so an electric car may be practical.", drools.getRule().getName());
end

rule "SCORE: Distance > 8000m favors PT/car only"
salience 60
when
  $f : Fact( context.distance_to_destination_meters > 8000 )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 30, "Very long distance makes public transport or car most practical.", drools.getRule().getName());
  $f.addScore(Mode.GAS_CAR, 25, "Very long distance makes a gas car practical.", drools.getRule().getName());
  $f.addScore(Mode.ELECTRIC_CAR, 27, "Very long distance makes an electric car practical.", drools.getRule().getName());
end

rule "SCORE: PT station near"
salience 65
when
  $f : Fact( context.distance_to_next_public_transport_station_meters >= 0,
             context.distance_to_next_public_transport_station_meters < 400 )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 20, "A public transport stop is nearby.", drools.getRule().getName());
end

rule "SCORE: Bike sharing station near and bikes available"
salience 65
when
  $f : Fact( context.distance_to_next_bikesharing_station_meters >= 0,
             context.distance_to_next_bikesharing_station_meters < 300,
             context.bikesAvailableAtStation == true )
then
  $f.addScore(Mode.BIKESHARE, 20, "A bike sharing station with available bikes is nearby.", drools.getRule().getName());
end

rule "SCORE: Preferred mode boost"
salience 75
when
  $f : Fact( preferences.preferred_transport_modes != null )
then
  java.util.List prefs = $f.getPreferences().getPreferred_transport_modes();
  if (prefs == null || prefs.isEmpty()) return;

  for (Object o : prefs) {
    if (o == null) continue;

    String p = o.toString().trim().toUpperCase()
                .replace('-', '_')
                .replace(' ', '_');

    if ("WALK".equals(p)) {
      $f.addScore(Mode.WALK, 12, "You prefer walking.", drools.getRule().getName());
    }
    else if ("BIKE".equals(p)) {
      $f.addScore(Mode.BIKE, 12, "You prefer biking.", drools.getRule().getName());
    }
    else if ("E_BIKE".equals(p)) {
      $f.addScore(Mode.E_BIKE, 12, "You prefer e-biking.", drools.getRule().getName());
    }
    else if ("SCOOTER".equals(p)) {
      $f.addScore(Mode.SCOOTER, 12, "You prefer scooter.", drools.getRule().getName());
    }
    else if ("E_SCOOTER".equals(p)) {
      $f.addScore(Mode.E_SCOOTER, 12, "You prefer e-scooter.", drools.getRule().getName());
    }
    else if ("BIKESHARE".equals(p)) {
      $f.addScore(Mode.BIKESHARE, 12, "You prefer bike sharing.", drools.getRule().getName());
    }
    else if ("PUBLIC_TRANSPORT".equals(p)) {
      $f.addScore(Mode.PUBLIC_TRANSPORT, 12, "You prefer public transport.", drools.getRule().getName());
    }
    else if ("GAS_CAR".equals(p)) {
      $f.addScore(Mode.GAS_CAR, 12, "You prefer gas car.", drools.getRule().getName());
    }
    else if ("ELECTRIC_CAR".equals(p)) {
      $f.addScore(Mode.ELECTRIC_CAR, 12, "You prefer electric car.", drools.getRule().getName());
    }
  }
end

rule "SCORE: High environmental factor boosts eco modes"
salience 55
when
  $f : Fact( preferences.environmentally_sustainable == true,
             context.environmental_factor >= 0.75 )
then
  $f.addScore(Mode.WALK, 10, "High environmental factor favors walking.", drools.getRule().getName());
  $f.addScore(Mode.BIKE, 10, "High environmental factor favors biking.", drools.getRule().getName());
  $f.addScore(Mode.E_BIKE, 9, "High environmental factor favors e-biking.", drools.getRule().getName());
  $f.addScore(Mode.SCOOTER, 9, "High environmental factor favors scooter.", drools.getRule().getName());
  $f.addScore(Mode.E_SCOOTER, 9, "High environmental factor favors e-scooter.", drools.getRule().getName());
  $f.addScore(Mode.PUBLIC_TRANSPORT, 5, "High environmental factor favors public transport.", drools.getRule().getName());
end

rule "SCORE: Good weather boosts active modes"
salience 85
when
  $f : Fact( preferences.weather_ok == true )
then
  $f.addScore(Mode.WALK, 10, "Good weather supports walking.", drools.getRule().getName());
  $f.addScore(Mode.BIKE, 10, "Good weather supports biking.", drools.getRule().getName());
  $f.addScore(Mode.E_BIKE, 10, "Good weather supports e-biking.", drools.getRule().getName());
  $f.addScore(Mode.SCOOTER, 10, "Good weather supports scooter.", drools.getRule().getName());
  $f.addScore(Mode.E_SCOOTER, 10, "Good weather supports e-scooter.", drools.getRule().getName());
end

rule "SCORE: Bad weather slightly boosts PT/car"
salience 85
when
  $f : Fact( preferences.weather_ok == false )
then
  $f.addScore(Mode.PUBLIC_TRANSPORT, 10, "Bad weather makes public transport more attractive.", drools.getRule().getName());
  $f.addScore(Mode.GAS_CAR, 5, "Bad weather can make a gas car more comfortable.", drools.getRule().getName());
  $f.addScore(Mode.ELECTRIC_CAR, 6, "Bad weather can make an electric car more comfortable.", drools.getRule().getName());
end

rule "SCORE: Bikeshare station far penalizes bikeshare"
salience 64
when
  $f : Fact( context.distance_to_next_bikesharing_station_meters >= 0,
             context.distance_to_next_bikesharing_station_meters > 700 )
then
  $f.addScore(Mode.BIKESHARE, -15, "Bike sharing station is far away, making it less convenient.", drools.getRule().getName());
end

// ---------------------------------------------
// Distance-based fallback if WALK is NOT preferred
// ---------------------------------------------

rule "SCORE: Short distance micromobility fallback (walk not preferred)"
salience 61
when
  $f : Fact(
    context.distance_to_destination_meters < 500,
    preferences.preferred_transport_modes != null
  )
then
  java.util.List prefs = $f.getPreferences().getPreferred_transport_modes();
  boolean walkPreferred = false;

  for (Object o : prefs) {
    if (o == null) continue;
    String p = o.toString().trim().toUpperCase().replace('-', '_').replace(' ', '_');
    if ("WALK".equals(p)) {
      walkPreferred = true;
      break;
    }
  }

  if (!walkPreferred) {
    $f.addScore(Mode.SCOOTER, 20, "Very short distance and walking is not preferred, so scooter is favored.", drools.getRule().getName());
  }
end

rule "SCORE: Short distance e-scooter fallback (walk not preferred)"
salience 61
when
  $f : Fact(
    context.distance_to_destination_meters >= 500,
    context.distance_to_destination_meters < 1000,
    preferences.preferred_transport_modes != null
  )
then
  java.util.List prefs = $f.getPreferences().getPreferred_transport_modes();
  boolean walkPreferred = false;

  for (Object o : prefs) {
    if (o == null) continue;
    String p = o.toString().trim().toUpperCase().replace('-', '_').replace(' ', '_');
    if ("WALK".equals(p)) {
      walkPreferred = true;
      break;
    }
  }

  if (!walkPreferred) {
    $f.addScore(Mode.E_SCOOTER, 22, "Short distance and walking is not preferred, so e-scooter is favored.", drools.getRule().getName());
  }
end

rule "SCORE: Medium distance bike fallback (walk not preferred)"
salience 61
when
  $f : Fact(
    context.distance_to_destination_meters >= 1000,
    context.distance_to_destination_meters < 3000,
    preferences.preferred_transport_modes != null
  )
then
  java.util.List prefs = $f.getPreferences().getPreferred_transport_modes();
  boolean walkPreferred = false;

  for (Object o : prefs) {
    if (o == null) continue;
    String p = o.toString().trim().toUpperCase().replace('-', '_').replace(' ', '_');
    if ("WALK".equals(p)) {
      walkPreferred = true;
      break;
    }
  }

  if (!walkPreferred) {
    $f.addScore(Mode.BIKE, 25, "Medium distance and walking is not preferred, so biking is favored.", drools.getRule().getName());
  }
end

rule "SCORE: Long medium distance e-bike fallback (walk not preferred)"
salience 61
when
  $f : Fact(
    context.distance_to_destination_meters >= 3000,
    context.distance_to_destination_meters <= 5000,
    preferences.preferred_transport_modes != null
  )
then
  java.util.List prefs = $f.getPreferences().getPreferred_transport_modes();
  boolean walkPreferred = false;

  for (Object o : prefs) {
    if (o == null) continue;
    String p = o.toString().trim().toUpperCase().replace('-', '_').replace(' ', '_');
    if ("WALK".equals(p)) {
      walkPreferred = true;
      break;
    }
  }

  if (!walkPreferred) {
    $f.addScore(Mode.E_BIKE, 25, "Longer medium distance and walking is not preferred, so e-biking is favored.", drools.getRule().getName());
  }
end

// ---------------------------
// 3) FINAL DECISION RULE
// ---------------------------

rule "DECIDE: Select highest score"
salience -10
when
  $f : Fact()
then
  Mode best = null;
  int bestScore = Integer.MIN_VALUE;
  int secondScore = Integer.MIN_VALUE;

  for (java.util.Map.Entry<Mode, Integer> e : $f.getAllScores().entrySet()) {
    Mode m = e.getKey();
    if ($f.isDisqualified(m)) continue;

    int s = e.getValue();
    if (s > bestScore) {
      secondScore = bestScore;
      bestScore = s;
      best = m;
    } else if (s > secondScore) {
      secondScore = s;
    }
  }

  if (best == null) {
    $f.setRecommended(null);
    $f.setConfidenceScore(0.0);
    $f.getReasons().add("No feasible transport mode could be selected based on the given constraints.");
    $f.getRulesTriggered().add(drools.getRule().getName());
  } else {
    $f.setRecommended(best);

    // Confidence: if no runner-up exists, we are maximally confident
    if (secondScore == Integer.MIN_VALUE) {
      $f.setConfidenceScore(1.0);
    } else {
      double gap = (double) (bestScore - secondScore);
      double denom = Math.max(30.0, Math.abs((double) bestScore));
      double conf = Math.max(0.0, Math.min(1.0, gap / denom));
      $f.setConfidenceScore(conf);
    }

    String pretty = best.toString().toLowerCase().replace('_', ' ');
    pretty = pretty.substring(0, 1).toUpperCase() + pretty.substring(1);

    $f.getReasons().add("Selected " + pretty + " because it had the best overall score among feasible options.");
    $f.getRulesTriggered().add(drools.getRule().getName());
  }
end